# `dist/index.js` is a special file in Actions.
# When you reference an action with `uses:` in a workflow,
# `index.js` is the code that will run.
# For our project, we generate this file through a build process from other source files.
# We need to make sure the checked-in `index.js` actually matches what we expect it to be.
name: Build dist

on:
    workflow_run:
        workflows: [push-test]
        types:
            - completed

jobs:
    on-success:
        name: build-dist
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'success' }}

        steps:
            - uses: actions/checkout@v3
              with:
                  fetch-depth: 0

            - name: Set Node.js 16.x
              uses: actions/setup-node@v3.6.0
              with:
                  node-version: 16.x

            - name: Pull
              run: |
                  git pull --rebase

            - name: Install dependencies
              run: npm ci

            - name: Build the dist/ directory
              run: npm run prepare

            - name: check for changes
              run: |
                  if git diff --exit-code; then
                    echo "changes_exist=false" >> "$GITHUB_ENV"
                  else
                    echo "changes_exist=true" >> "$GITHUB_ENV"
                  fi

            - name: Commit
              if: ${{ env.changes_exist == 'true' }}
              run: |
                  git config --global user.name 'kevinhws'
                  git config --global user.email 'kevinshu1995@gmail.com'
                  git commit -am "ci:ðŸŽ¡ (gh-action) build dist"
            - name: Push changes
              uses: ad-m/github-push-action@master
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  branch: develope

    on-failure:
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'failure' }}
        steps:
            - run: echo 'The triggering workflow failed'

